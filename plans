Implementation Plan: Private AI Chat with Browser-Side LLM                                                                                                                           
                                                                                                                                                                                      
 Overview                                                                                                                                                                             
                                                                                                                                                                                      
 Transform the story generator into a full-featured, privacy-first chat application running LLMs entirely in the browser, with Firebase hosting and optional cloud history sync.      
                                                                                                                                                                                      
 ---                                                                                                                                                                                  
 Phase 1: Add More WebLLM Models                                                                                                                                                      
                                                                                                                                                                                      
 Models to Add (Browser-Compatible)                                                                                                                                                   
 ┌───────────────────────────────────┬──────┬─────────────────────────────┬────────┐                                                                                                  
 │               Model               │ Size │          Use Case           │ Memory │                                                                                                  
 ├───────────────────────────────────┼──────┼─────────────────────────────┼────────┤                                                                                                  
 │ Qwen3-0.6B-q4f16_1-MLC            │ 0.6B │ Fast, lightweight (current) │ ~400MB │                                                                                                  
 ├───────────────────────────────────┼──────┼─────────────────────────────┼────────┤                                                                                                  
 │ SmolLM2-1.7B-Instruct-q4f16_1-MLC │ 1.7B │ Best small model quality    │ ~1GB   │                                                                                                  
 ├───────────────────────────────────┼──────┼─────────────────────────────┼────────┤                                                                                                  
 │ Llama-3.2-1B-Instruct-q4f16_1-MLC │ 1B   │ Meta's edge-optimized       │ ~600MB │                                                                                                  
 ├───────────────────────────────────┼──────┼─────────────────────────────┼────────┤                                                                                                  
 │ Llama-3.2-3B-Instruct-q4f16_1-MLC │ 3B   │ Better quality              │ ~2GB   │                                                                                                  
 ├───────────────────────────────────┼──────┼─────────────────────────────┼────────┤                                                                                                  
 │ Phi-4-mini-instruct-q4f16_1-MLC   │ 3.8B │ Microsoft's latest          │ ~2.5GB │                                                                                                  
 ├───────────────────────────────────┼──────┼─────────────────────────────┼────────┤                                                                                                  
 │ Gemma-2-2b-it-q4f16_1-MLC         │ 2B   │ Google's efficient model    │ ~1.2GB │                                                                                                  
 └───────────────────────────────────┴──────┴─────────────────────────────┴────────┘                                                                                                  
 Files to Modify                                                                                                                                                                      
                                                                                                                                                                                      
 - app.js - Add model selection logic and model configs                                                                                                                               
                                                                                                                                                                                      
 ---                                                                                                                                                                                  
 Phase 2: UI Redesign - "Chat with LLM, 100% Private"                                                                                                                                 
                                                                                                                                                                                      
 New UI Components                                                                                                                                                                    
                                                                                                                                                                                      
 1. Header: "Chat with LLM - 100% Private"                                                                                                                                            
 2. Model Selector: Dropdown to choose model                                                                                                                                          
 3. Chat History Panel: Message bubbles (user/assistant)                                                                                                                              
 4. Input Area: Text input + send button                                                                                                                                              
 5. Status Bar: Model loading progress, token count                                                                                                                                   
 6. Settings Panel: Clear history, export chat                                                                                                                                        
                                                                                                                                                                                      
 Files to Modify                                                                                                                                                                      
                                                                                                                                                                                      
 - index.html - Complete UI redesign with chat interface                                                                                                                              
                                                                                                                                                                                      
 New Styles                                                                                                                                                                           
                                                                                                                                                                                      
 - Chat bubbles (user: right-aligned blue, AI: left-aligned gray)                                                                                                                     
 - Responsive design                                                                                                                                                                  
 - Dark/light mode support                                                                                                                                                            
                                                                                                                                                                                      
 ---                                                                                                                                                                                  
 Phase 3: Chat History & Memory Management                                                                                                                                            
                                                                                                                                                                                      
 Local Chat History                                                                                                                                                                   
                                                                                                                                                                                      
 - Store messages in array: [{role, content, timestamp}]                                                                                                                              
 - Display as scrollable chat with proper formatting                                                                                                                                  
 - Persist to localStorage for session continuity                                                                                                                                     
                                                                                                                                                                                      
 Context Window Management Strategy                                                                                                                                                   
                                                                                                                                                                                      
 Based on best practices research:                                                                                                                                                    
                                                                                                                                                                                      
 1. Token Counting: Track approximate tokens (chars/4 estimate)                                                                                                                       
 2. Rolling Summarization: When approaching 70% of context limit:                                                                                                                     
   - Take oldest N messages (excluding system prompt)                                                                                                                                 
   - Ask model to summarize: "Summarize this conversation concisely, preserving key facts and context"                                                                                
   - Replace old messages with summary as system context                                                                                                                              
 3. Hybrid Approach: Keep last 5-10 messages verbatim + summary of older ones                                                                                                         
                                                                                                                                                                                      
 Implementation                                                                                                                                                                       
                                                                                                                                                                                      
 const MAX_CONTEXT_TOKENS = 4096; // Model dependent                                                                                                                                  
 const SUMMARIZE_THRESHOLD = 0.7; // 70%                                                                                                                                              
                                                                                                                                                                                      
 async function manageContext(messages) {                                                                                                                                             
   const tokenCount = estimateTokens(messages);                                                                                                                                       
   if (tokenCount > MAX_CONTEXT_TOKENS * SUMMARIZE_THRESHOLD) {                                                                                                                       
     return await summarizeOldMessages(messages);                                                                                                                                     
   }                                                                                                                                                                                  
   return messages;                                                                                                                                                                   
 }                                                                                                                                                                                    
                                                                                                                                                                                      
 Files to Create/Modify                                                                                                                                                               
                                                                                                                                                                                      
 - app.js - Add memory management module                                                                                                                                              
 - New: memory.js - Summarization and context management                                                                                                                              
                                                                                                                                                                                      
 ---                                                                                                                                                                                  
 Phase 4: Firebase Integration                                                                                                                                                        
                                                                                                                                                                                      
 Firebase Project Setup                                                                                                                                                               
                                                                                                                                                                                      
 - Project ID: AI-chat-In-Your-Tab                                                                                                                                                    
 - Services: Hosting, Firestore, Anonymous Auth                                                                                                                                       
                                                                                                                                                                                      
 File Structure for Firebase                                                                                                                                                          
                                                                                                                                                                                      
 ├── public/                                                                                                                                                                          
 │   ├── index.html                                                                                                                                                                   
 │   ├── app.js                                                                                                                                                                       
 │   ├── memory.js                                                                                                                                                                    
 │   ├── firebase-config.js                                                                                                                                                           
 │   └── styles.css                                                                                                                                                                   
 ├── firebase.json                                                                                                                                                                    
 ├── firestore.rules                                                                                                                                                                  
 ├── .firebaserc                                                                                                                                                                      
 └── README.md                                                                                                                                                                        
                                                                                                                                                                                      
 firebase.json Configuration                                                                                                                                                          
                                                                                                                                                                                      
 {                                                                                                                                                                                    
   "hosting": {                                                                                                                                                                       
     "public": "public",                                                                                                                                                              
     "ignore": ["firebase.json", "**/.*", "**/node_modules/**"],                                                                                                                      
     "headers": [{                                                                                                                                                                    
       "source": "**/*",                                                                                                                                                              
       "headers": [{                                                                                                                                                                  
         "key": "Cross-Origin-Opener-Policy",                                                                                                                                         
         "value": "same-origin"                                                                                                                                                       
       }, {                                                                                                                                                                           
         "key": "Cross-Origin-Embedder-Policy",                                                                                                                                       
         "value": "require-corp"                                                                                                                                                      
       }]                                                                                                                                                                             
     }]                                                                                                                                                                               
   }                                                                                                                                                                                  
 }                                                                                                                                                                                    
                                                                                                                                                                                      
 Note: COOP/COEP headers required for SharedArrayBuffer (WebLLM performance)                                                                                                          
                                                                                                                                                                                      
 Files to Create                                                                                                                                                                      
                                                                                                                                                                                      
 - firebase.json - Hosting config                                                                                                                                                     
 - .firebaserc - Project alias                                                                                                                                                        
 - firestore.rules - Security rules                                                                                                                                                   
 - public/firebase-config.js - Firebase initialization                                                                                                                                
                                                                                                                                                                                      
 ---                                                                                                                                                                                  
 Phase 5: User Authentication & History Sync                                                                                                                                          
                                                                                                                                                                                      
 Anonymous Authentication                                                                                                                                                             
                                                                                                                                                                                      
 import { getAuth, signInAnonymously, onAuthStateChanged } from 'firebase/auth';                                                                                                      
                                                                                                                                                                                      
 const auth = getAuth();                                                                                                                                                              
 await signInAnonymously(auth);                                                                                                                                                       
 // User gets unique UID automatically                                                                                                                                                
                                                                                                                                                                                      
 Firestore Data Structure                                                                                                                                                             
                                                                                                                                                                                      
 users/                                                                                                                                                                               
   {userId}/                                                                                                                                                                          
     profile/                                                                                                                                                                         
       createdAt: timestamp                                                                                                                                                           
       lastActive: timestamp                                                                                                                                                          
     chats/                                                                                                                                                                           
       {chatId}/                                                                                                                                                                      
         title: string                                                                                                                                                                
         createdAt: timestamp                                                                                                                                                         
         updatedAt: timestamp                                                                                                                                                         
         messages/                                                                                                                                                                    
           {messageId}/                                                                                                                                                               
             role: "user" | "assistant" | "system"                                                                                                                                    
             content: string                                                                                                                                                          
             timestamp: timestamp                                                                                                                                                     
                                                                                                                                                                                      
 Security Rules (firestore.rules)                                                                                                                                                     
                                                                                                                                                                                      
 rules_version = '2';                                                                                                                                                                 
 service cloud.firestore {                                                                                                                                                            
   match /databases/{database}/documents {                                                                                                                                            
     match /users/{userId}/{document=**} {                                                                                                                                            
       allow read, write: if request.auth != null && request.auth.uid == userId;                                                                                                      
     }                                                                                                                                                                                
   }                                                                                                                                                                                  
 }                                                                                                                                                                                    
                                                                                                                                                                                      
 Files to Modify                                                                                                                                                                      
                                                                                                                                                                                      
 - public/app.js - Add Firebase auth integration                                                                                                                                      
 - New: public/db.js - Firestore operations                                                                                                                                           
                                                                                                                                                                                      
 ---                                                                                                                                                                                  
 Phase 6: Security Considerations                                                                                                                                                     
                                                                                                                                                                                      
 Client-Side Security                                                                                                                                                                 
                                                                                                                                                                                      
 1. No API keys in code - Use Firebase Auth tokens                                                                                                                                    
 2. Firestore rules - Users can only access their own data                                                                                                                            
 3. Input sanitization - Escape HTML in chat display                                                                                                                                  
 4. CSP headers - Restrict script sources                                                                                                                                             
                                                                                                                                                                                      
 Privacy Features                                                                                                                                                                     
                                                                                                                                                                                      
 1. Mandatory cloud sync - All chat history syncs to Firestore (user chose this)                                                                                                      
 2. Clear data option - Delete all cloud data                                                                                                                                         
 3. No tracking - No analytics or third-party scripts                                                                                                                                 
 4. Transparent - Show what data is stored where                                                                                                                                      
 5. Anonymous auth - No personal info required, just auto-generated UID                                                                                                               
                                                                                                                                                                                      
 ---                                                                                                                                                                                  
 File Changes Summary                                                                                                                                                                 
                                                                                                                                                                                      
 Files to Modify                                                                                                                                                                      
 ┌────────────┬────────────────────────────────────────────────┐                                                                                                                      
 │    File    │                    Changes                     │                                                                                                                      
 ├────────────┼────────────────────────────────────────────────┤                                                                                                                      
 │ index.html │ Complete UI redesign with chat interface       │                                                                                                                      
 ├────────────┼────────────────────────────────────────────────┤                                                                                                                      
 │ app.js     │ Model selection, chat logic, memory management │                                                                                                                      
 └────────────┴────────────────────────────────────────────────┘                                                                                                                      
 Files to Create                                                                                                                                                                      
 ┌───────────────────────────┬───────────────────────────────────────────┐                                                                                                            
 │           File            │                  Purpose                  │                                                                                                            
 ├───────────────────────────┼───────────────────────────────────────────┤                                                                                                            
 │ public/styles.css         │ Extracted styles for maintainability      │                                                                                                            
 ├───────────────────────────┼───────────────────────────────────────────┤                                                                                                            
 │ public/memory.js          │ Context window management & summarization │                                                                                                            
 ├───────────────────────────┼───────────────────────────────────────────┤                                                                                                            
 │ public/firebase-config.js │ Firebase initialization                   │                                                                                                            
 ├───────────────────────────┼───────────────────────────────────────────┤                                                                                                            
 │ public/db.js              │ Firestore operations                      │                                                                                                            
 ├───────────────────────────┼───────────────────────────────────────────┤                                                                                                            
 │ firebase.json             │ Firebase Hosting configuration            │                                                                                                            
 ├───────────────────────────┼───────────────────────────────────────────┤                                                                                                            
 │ .firebaserc               │ Firebase project alias                    │                                                                                                            
 ├───────────────────────────┼───────────────────────────────────────────┤                                                                                                            
 │ firestore.rules           │ Firestore security rules                  │                                                                                                            
 ├───────────────────────────┼───────────────────────────────────────────┤                                                                                                            
 │ MODELS.md                 │ Documentation of available models         │                                                                                                            
 └───────────────────────────┴───────────────────────────────────────────┘                                                                                                            
 Directory Structure After                                                                                                                                                            
                                                                                                                                                                                      
 llm_in_browser/                                                                                                                                                                      
 ├── public/                                                                                                                                                                          
 │   ├── index.html                                                                                                                                                                   
 │   ├── app.js                                                                                                                                                                       
 │   ├── styles.css                                                                                                                                                                   
 │   ├── memory.js                                                                                                                                                                    
 │   ├── firebase-config.js                                                                                                                                                           
 │   └── db.js                                                                                                                                                                        
 ├── firebase.json                                                                                                                                                                    
 ├── .firebaserc                                                                                                                                                                      
 ├── firestore.rules                                                                                                                                                                  
 ├── MODELS.md                                                                                                                                                                        
 └── README.md (updated)                                                                                                                                                              
                                                                                                                                                                                      
 ---                                                                                                                                                                                  
 Verification Plan                                                                                                                                                                    
                                                                                                                                                                                      
 1. Local Testing                                                                                                                                                                     
   - Serve with python -m http.server 8000                                                                                                                                            
   - Test model selection and loading                                                                                                                                                 
   - Test chat functionality and history display                                                                                                                                      
   - Test memory summarization (send many messages)                                                                                                                                   
   - Test localStorage persistence                                                                                                                                                    
 2. Firebase Testing                                                                                                                                                                  
   - Run firebase emulators:start for local Firestore/Auth testing                                                                                                                    
   - Verify anonymous auth creates user                                                                                                                                               
   - Verify chat history syncs to Firestore                                                                                                                                           
   - Test security rules with simulator                                                                                                                                               
 3. Deployment                                                                                                                                                                        
   - Run firebase deploy --only hosting                                                                                                                                               
   - Verify site loads at Firebase URL                                                                                                                                                
   - Test full flow in production                                                                                                                                                     
                                                                                                                                                                                      
 ---                                                                                                                                                                                  
 Dependencies                                                                                                                                                                         
                                                                                                                                                                                      
 NPM Packages (for Firebase CLI)                                                                                                                                                      
                                                                                                                                                                                      
 npm install -g firebase-tools                                                                                                                                                        
                                                                                                                                                                                      
 CDN Dependencies (in HTML)                                                                                                                                                           
                                                                                                                                                                                      
 - WebLLM: https://esm.run/@mlc-ai/web-llm@0.2.80                                                                                                                                     
 - Firebase: https://www.gstatic.com/firebasejs/10.x.x/firebase-*.js                                                                                                                  
                                                                                                                                                                                      
 ---                                                                                                                                                                                  
 Questions Resolved                                                                                                                                                                   
                                                                                                                                                                                      
 1. Model choices: Selected 6 browser-friendly models based on WebLLM compatibility and memory constraints                                                                            
 2. Summarization strategy: Rolling summarization at 70% context threshold                                                                                                            
 3. Auth method: Firebase Anonymous Auth (no user signup required)                                                                                                                    
 4. Data structure: Nested collections under user UID for security       


 All tasks are complete. Here's a summary of what was implemented:                                                                                                                   
                                                                                                                                                                                      
  Completed Implementation                                                                                                                                                            
                                                                                                                                                                                      
  Files Created                                                                                                                                                                       
                                                                                                                                                                                      
  Root Level:                                                                                                                                                                         
  - firebase.json - Firebase Hosting config with COOP/COEP headers for WebGPU                                                                                                         
  - .firebaserc - Project alias pointing to ai-chat-in-your-tab                                                                                                                       
  - firestore.rules - Security rules ensuring users only access their own data                                                                                                        
  - MODELS.md - Comprehensive documentation of 6 available models                                                                                                                     
  - README.md - Updated with new features and setup instructions                                                                                                                      
                                                                                                                                                                                      
  public/ Directory:                                                                                                                                                                  
  - index.html - Modern chat UI with sidebar, settings, model selector                                                                                                                
  - styles.css - Clean CSS with dark/light mode support                                                                                                                               
  - app.js - Main app logic (model selection, chat, streaming)                                                                                                                        
  - memory.js - Context window management with rolling summarization                                                                                                                  
  - firebase-config.js - Firebase initialization (needs your API keys)                                                                                                                
  - db.js - Firestore CRUD operations for chats and messages                                                                                                                          
                                                                                                                                                                                      
  Key Features Implemented                                                                                                                                                            
                                                                                                                                                                                      
  1. 6 Browser-Compatible Models: Qwen3-0.6B, Llama-3.2-1B/3B, SmolLM2-1.7B, Gemma-2-2B, Phi-4-mini                                                                                   
  2. Chat UI: Message bubbles, typing indicators, sidebar with chat history                                                                                                           
  3. Memory Management: Rolling summarization at 70% context threshold                                                                                                                
  4. Firebase Integration: Anonymous auth, Firestore sync, security rules                                                                                                             
  5. User Experience: Dark/light mode, export, multiple chats                                                                                                                         
                                                                                                                                                                                      
  Before Deploying                                                                                                                                                                    
                                                                                                                                                                                      
  You need to:                                                                                                                                                                        
  1. Add Firebase config - Edit public/firebase-config.js with your actual API keys from Firebase Console                                                                             
  2. Enable Firebase services in console:                                                                                                                                             
    - Authentication > Anonymous sign-in                                                                                                                                              
    - Cloud Firestore database                                                                                                                                                        
  3. Deploy rules: firebase deploy --only firestore:rules                                                                                                                             
  4. Deploy site: firebase deploy --only hosting                                                                                                                                      
                                                                                                                                                                                      
  Test Locally                                                                                                                                                                        
                                                                                                                                                                                      
  cd /Users/annabeketova/Desktop/code/extensions/llm_in_browser/public                                                                                                                
  python -m http.server 8000                                                                                                                                                          
                                                                                                                                                                                      
  Then open http://localhost:8000 in Chrome.  


  To fix the Firebase error:                                                                                                                                                   
                                                                                                                                                                               
  1. Get your Firebase config:                                                                                                                                                 
    - Go to https://console.firebase.google.com                                                                                                                                
    - Create or select project ai-chat-in-your-tab                                                                                                                             
    - Go to Project Settings > General > Your apps                                                                                                                             
    - If no web app exists, click Add app > Web                                                                                                                                
    - Copy the config object                                                                                                                                                   
  2. Update public/firebase-config.js:                                                                                                                                         
  Replace lines 13-20 with your real values:                                                                                                                                   
  const firebaseConfig = {                                                                                                                                                     
    apiKey: "AIzaSy...",  // Your actual key                                                                                                                                   
    authDomain: "ai-chat-in-your-tab.firebaseapp.com",                                                                                                                         
    projectId: "ai-chat-in-your-tab",                                                                                                                                          
    storageBucket: "ai-chat-in-your-tab.firebasestorage.app",                                                                                                                  
    messagingSenderId: "123456789",  // Your actual ID                                                                                                                         
    appId: "1:123..."  // Your actual app ID                                                                                                                                   
  };                                                                                                                                                                           
  3. Enable Anonymous Auth in Firebase Console:                                                                                                                                
    - Go to Authentication > Sign-in method                                                                                                                                    
    - Enable Anonymous                                                                                                                                                         
  4. Create Firestore Database:                                                                                                                                                
    - Go to Firestore Database > Create database                                                                                                                               
    - Start in production mode                                                                                                                                                 
                                                                                                                                                                               
  Then test again with python -m http.server 8000 in the public/ directory. 




  # Login to Firebase (if not already)                                                                                                                                         
  firebase login                                                                                                                                                               
                                                                                                                                                                               
  # Deploy everything (hosting + firestore rules)                                                                                                                              
  firebase deploy                                                                                                                                                              
                                                                                                                                                                               
  Or deploy specific parts:                                                                                                                                                    
                                                                                                                                                                               
  # Just hosting (the website)                                                                                                                                                 
  firebase deploy --only hosting                                                                                                                                               
                                                                                                                                                                               
  # Just Firestore rules                                                                                                                                                       
  firebase deploy --only firestore:rules

  To fix the Firebase error:                                                                                                                                                   
                                                                                                                                                                               
  1. Get your Firebase config:                                                                                                                                                 
    - Go to https://console.firebase.google.com                                                                                                                                
    - Create or select project ai-chat-in-your-tab                                                                                                                             
    - Go to Project Settings > General > Your apps                                                                                                                             
    - If no web app exists, click Add app > Web                                                                                                                                
    - Copy the config object                                                                                                                                                   
  2. Update public/firebase-config.js:                                                                                                                                         
  Replace lines 13-20 with your real values:                                                                                                                                   
  const firebaseConfig = {                                                                                                                                                     
    apiKey: "AIzaSy...",  // Your actual key                                                                                                                                   
    authDomain: "ai-chat-in-your-tab.firebaseapp.com",                                                                                                                         
    projectId: "ai-chat-in-your-tab",                                                                                                                                          
    storageBucket: "ai-chat-in-your-tab.firebasestorage.app",                                                                                                                  
    messagingSenderId: "123456789",  // Your actual ID                                                                                                                         
    appId: "1:123..."  // Your actual app ID                                                                                                                                   
  };                                                                                                                                                                           
  3. Enable Anonymous Auth in Firebase Console:                                                                                                                                
    - Go to Authentication > Sign-in method                                                                                                                                    
    - Enable Anonymous                                                                                                                                                         
  4. Create Firestore Database:                                                                                                                                                
    - Go to Firestore Database > Create database                                                                                                                               
    - Start in production mode                                                                                                                                                 
                                                                                                                                                                               
  Then test again with python -m http.server 8000 in the public/ directory.   